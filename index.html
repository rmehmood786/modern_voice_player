<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aurora Voice Player</title>
<style>
  :root{
    --bg:#f3f6fd; --panel:#ffffff; --text:#0f1a2b; --muted:#6b7280; --border:#e5e7eb;
    --primary:#3b82f6; --primary2:#6366f1; --accent:#10b981; --warn:#f59e0b; --danger:#ef4444;
    --chip:#eef2ff; --chipText:#1e3a8a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, sans-serif}
  /* NAV */
  .nav{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;color:#fff;
       background:linear-gradient(90deg,var(--primary2),var(--primary));box-shadow:0 12px 32px rgba(22,28,45,.18)}
  .brand{display:flex;gap:.6rem;align-items:center;font-weight:800}
  .nav-right{display:flex;gap:12px;align-items:center}
  .chip{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.35);color:#fff;padding:6px 10px;border-radius:999px;font-weight:700}
  /* LAYOUT */
  .container{max-width:1200px;margin:22px auto;padding:0 14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:20px;
        box-shadow:0 12px 36px rgba(30,41,59,.10);margin-bottom:20px}
  .card-h{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border)}
  .badge{background:#e6f0ff;color:#1f3a93;border-radius:999px;padding:4px 10px;font-weight:800;font-size:.8rem}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;padding:16px}
  @media (max-width:1000px){.grid{grid-template-columns:1fr}}
  .row{display:flex;gap:8px;align-items:center}
  .hidden{display:none!important}
  /* MEDIA */
  .media-card{padding:14px;border:1px solid var(--border);border-radius:16px;background:#fafbff}
  .player-wrap{position:relative;width:100%;aspect-ratio:16/9;background:#0b1020;border-radius:14px;overflow:hidden;border:1px solid var(--border)}
  .theater .player-wrap{aspect-ratio:auto;height:62vh}
  .overlay-dim{position:fixed;inset:0;background:rgba(8,11,23,.65);backdrop-filter:blur(1px);opacity:0;pointer-events:none;transition:.2s}
  .theater .overlay-dim{opacity:1;pointer-events:auto}
  #viz{width:100%;height:88px;border-radius:10px;background:#eef2ff;border:1px solid var(--border);margin-top:10px}
  .title{font-weight:800;margin-top:8px}
  .sub{color:var(--muted)}
  /* CONTROLS */
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btn{border:none;border-radius:999px;font-weight:800;cursor:pointer;padding:8px 14px}
  .btn.primary{background:linear-gradient(90deg,var(--primary),var(--primary2));color:#fff}
  .btn.icon{padding:8px 10px;background:#eef2ff;color:#1e3a8a}
  .btn.ghost{background:#eef2ff;color:#1f2a5a}
  .btn.warn{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
  .btn.good{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
  .btn:hover{filter:brightness(.98)}
  .seek{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center;margin-top:8px}
  .sliders{display:flex;gap:18px;flex-wrap:wrap;margin-top:8px}
  .slider{display:grid;gap:6px;min-width:220px}
  .toggles{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:8px}
  .status{color:var(--muted)}
  .pill{background:#fee2e2;color:#7f1d1d;padding:3px 12px;border-radius:999px;font-weight:800}
  .pill.on{background:#dcfce7;color:#14532d}
  /* PLAYLIST */
  .tools{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .tools .btn{background:var(--chip);color:var(--chipText)}
  .playlist{list-style:none;margin:0;padding:0;border:1px dashed var(--border);border-radius:12px;min-height:150px;background:#f8fafc}
  .playlist li{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;
               padding:8px 10px;border-bottom:1px solid var(--border);cursor:grab;background:#fff}
  .playlist li:last-child{border-bottom:none}
  .thumb{width:56px;height:42px;border-radius:8px;object-fit:cover;border:1px solid var(--border)}
  .row-title{font-weight:800}
  .row-sub{color:var(--muted);font-size:.9rem}
  .truncate{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:460px}
  .row-actions{display:flex;gap:6px}
  /* BOOKMARKS */
  .marks{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .mark{background:#e0f2fe;color:#075985;border:1px solid #bae6fd;border-radius:999px;padding:4px 8px;cursor:pointer;font-weight:700}
  .ab{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  /* TOASTS */
  .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;
         box-shadow:0 12px 30px rgba(0,0,0,.25);opacity:0;transform:translateY(10px);transition:.25s}
  .toast.show{opacity:1;transform:translateY(0)}
  /* MINI BAR */
  .mini{position:sticky;bottom:-1px;background:#eef2ff;border-top:1px solid var(--border);padding:10px;border-radius:0 0 20px 20px}
  .mini .truncate{max-width:300px}
</style>
</head>
<body>
  <div id="dim" class="overlay-dim"></div>

  <nav class="nav">
    <div class="brand"><span>üéß</span><span>Aurora Voice Player</span></div>
    <div class="nav-right">
      <label class="row" style="gap:8px">
        <input id="speechToggle" type="checkbox" />
        <span>Speech input</span>
      </label>
      <label class="row" style="gap:8px">
        <input id="micToggle" type="checkbox" />
        <span>Mic ducking</span>
      </label>
      <button id="install" class="chip">Install</button>
    </div>
  </nav>

  <main class="container">
    <!-- MAIN -->
    <section class="card" id="shell">
      <div class="card-h">
        <h1 style="margin:0;font-size:1.05rem">Aurora Voice Player</h1>
        <span class="badge" id="modeBadge">Web App</span>
      </div>

      <div class="grid">
        <!-- LEFT: media -->
        <div class="media-card">
          <div class="player-wrap" id="playerWrap" aria-label="Player area">
            <div id="ytMount" class="hidden" aria-label="YouTube player"></div>
            <img id="cover" class="cover" src="https://dummyimage.com/1280x720/0b1020/ffffff&text=Ready" alt="Cover"/>
          </div>
          <canvas id="viz" aria-label="Audio visualization"></canvas>

          <div class="title truncate" id="trackTitle">‚Äî</div>
          <div class="sub" id="trackSub">‚Äî</div>

          <div class="controls">
            <button id="prev" class="btn icon" title="Shift+Left">‚èÆÔ∏è</button>
            <button id="rew"  class="btn icon" title="Left (‚Äì30s)">‚è™</button>
            <button id="play" class="btn primary" title="Space">Play</button>
            <button id="fwd"  class="btn icon" title="Right (+30s)">‚è©</button>
            <button id="next" class="btn icon" title="Shift+Right">‚è≠Ô∏è</button>

            <select id="rate" class="btn ghost" title="Playback speed">
              <option value="0.5">0.5√ó</option>
              <option value="0.75">0.75√ó</option>
              <option value="1" selected>1.0√ó</option>
              <option value="1.25">1.25√ó</option>
              <option value="1.5">1.5√ó</option>
              <option value="1.75">1.75√ó</option>
              <option value="2">2.0√ó</option>
            </select>

            <select id="sleep" class="btn ghost" title="Sleep timer">
              <option value="0">Sleep: off</option>
              <option value="5">5 min</option>
              <option value="15">15 min</option>
              <option value="30">30 min</option>
              <option value="60">60 min</option>
            </select>

            <button id="theater" class="btn ghost" title="Theater mode">Theater</button>
            <button id="share" class="btn ghost" title="Copy timestamp link">Share ‚è±Ô∏è</button>
          </div>

          <div class="seek">
            <span id="tCur">00:00</span>
            <input id="seek" type="range" min="0" max="1000" value="0"/>
            <span id="tDur">00:00</span>
          </div>

          <div class="sliders">
            <label class="slider"><span>Volume</span><input id="vol" type="range" min="0" max="100" value="80"/></label>
            <label class="slider"><span>Ducking</span><input id="duck" type="range" min="20" max="100" value="35"/></label>
          </div>

          <div class="ab">
            <button id="setA" class="btn good" title="Set loop start">Set A</button>
            <button id="setB" class="btn good" title="Set loop end">Set B</button>
            <button id="toggleAB" class="btn warn" title="Toggle A‚ÄìB loop">A‚ÄìB: OFF</button>
            <button id="addMark" class="btn ghost" title="Add bookmark at current time">+ Bookmark</button>
          </div>
          <div id="marks" class="marks" aria-label="Bookmarks"></div>

          <div class="toggles">
            <label><input id="repeat" type="checkbox"/> Repeat</label>
            <label><input id="shuffle" type="checkbox" checked/> Shuffle</label>
            <span id="status" class="status">Ready.</span>
            <span id="micPill" class="pill">mic: off</span>
          </div>

          <div class="toggles">
            <select id="voice" style="max-width:320px"></select>
            <button id="speakEn" class="btn ghost">Speak EN</button>
            <button id="speakUr" class="btn ghost">Speak ÿßÿ±ÿØŸà</button>
            <button id="stopTTS" class="btn warn">Stop TTS</button>
          </div>
        </div>

        <!-- RIGHT: playlist -->
        <div class="media-card">
          <div class="tools">
            <button id="addYT" class="btn">üì∫ Add YouTube</button>
            <label><input id="addLocal" type="file" accept="audio/*" multiple style="display:none"/><span class="btn">üéµ Add Local</span></label>
            <button id="saveList" class="btn">üíæ Save</button>
            <button id="clearList" class="btn warn">üßπ Clear</button>
          </div>
          <ul id="list" class="playlist" aria-label="Playlist (drag to reorder)"></ul>
        </div>
      </div>

      <!-- Sticky miniboard -->
      <div class="mini row" style="justify-content:space-between">
        <div class="row" style="gap:10px">
          <strong class="truncate" id="miniTitle">‚Äî</strong>
          <span class="status" id="miniSub">‚Äî</span>
        </div>
        <div class="row">
          <button id="miniPrev" class="btn icon">‚èÆÔ∏è</button>
          <button id="miniPlay" class="btn primary">Play</button>
          <button id="miniNext" class="btn icon">‚è≠Ô∏è</button>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

<script>
/* ========= UTIL ========= */
const $ = (s)=>document.querySelector(s);
const fmt = s => { s=Math.max(0,Math.floor(s)); const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return m+':'+ss };
const params = new URLSearchParams(location.search);
function toast(msg){const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400);}

/* ========= STATE ========= */
const SEEK_STEP=30, MIC_THRESHOLD=0.025, QUIET_DELAY=1000, DUCK_TICK=60, VIZ_BARS=64;
let state={
  playlist:[], index:0, isPlaying:false, useYT:false,
  repeat:false, shuffle:true, duration:0,
  lastSpeech:0, duckAmt:.35, vol:.9, ttsIndex:null,
  speechOn:false, micOn:false, rate:1.0,
  A:null, B:null, loopAB:false, sleepId:null
};

/* ========= DOM ========= */
const els={
  shell:$('#shell'), dim:$('#dim'), wrap:$('#playerWrap'), ytMount:$('#ytMount'), cover:$('#cover'), viz:$('#viz'),
  title:$('#trackTitle'), sub:$('#trackSub'), status:$('#status'),
  prev:$('#prev'), rew:$('#rew'), play:$('#play'), fwd:$('#fwd'), next:$('#next'),
  miniPrev:$('#miniPrev'), miniPlay:$('#miniPlay'), miniNext:$('#miniNext'),
  miniTitle:$('#miniTitle'), miniSub:$('#miniSub'),
  seek:$('#seek'), tCur:$('#tCur'), tDur:$('#tDur'),
  vol:$('#vol'), duck:$('#duck'), repeat:$('#repeat'), shuffle:$('#shuffle'),
  list:$('#list'), addYT:$('#addYT'), addLocal:$('#addLocal'),
  saveList:$('#saveList'), clearList:$('#clearList'),
  speechToggle:$('#speechToggle'), micToggle:$('#micToggle'), micPill:$('#micPill'),
  voice:$('#voice'), speakEn:$('#speakEn'), speakUr:$('#speakUr'), stopTTS:$('#stopTTS'),
  share:$('#share'), rate:$('#rate'), sleep:$('#sleep'), theater:$('#theater')
};
function setStatus(msg,kind='info'){els.status.textContent=msg; els.status.style.color=(kind==='error')?'var(--danger)':'var(--muted)'}
function updatePlayBtns(){ els.play.textContent = state.isPlaying ? 'Pause':'Play'; els.miniPlay.textContent = state.isPlaying ? 'Pause':'Play'; }
function setMeta({title,sub,cover}){ els.title.textContent=title||'‚Äî'; els.sub.textContent=sub||'‚Äî'; if(cover) els.cover.src=cover; els.miniTitle.textContent=title||'‚Äî'; els.miniSub.textContent=sub||'‚Äî'; }

/* ========= LOCAL AUDIO + WEBAUDIO ========= */
const audioEl=new Audio(); audioEl.crossOrigin='anonymous';
const ctx=new (window.AudioContext||window.webkitAudioContext)();
const src=ctx.createMediaElementSource(audioEl);
const gain=ctx.createGain(); gain.gain.value=state.vol;
const analyser=ctx.createAnalyser(); analyser.fftSize=2048; analyser.smoothingTimeConstant=.85;
src.connect(gain).connect(analyser).connect(ctx.destination);

/* Visualization */
(function(){
  const g = els.viz.getContext('2d');
  const resize=()=>{ const r=els.viz.getBoundingClientRect(); els.viz.width=r.width|0; els.viz.height=88; };
  resize(); addEventListener('resize',resize);
  (function loop(){
    const buf=new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(buf);
    g.clearRect(0,0,els.viz.width,els.viz.height);
    const step=Math.floor(buf.length/VIZ_BARS), w=(els.viz.width/VIZ_BARS)-2;
    for(let i=0;i<VIZ_BARS;i++){const v=buf[i*step]/255, h=v*els.viz.height, x=i*(w+2), y=els.viz.height-h;
      g.fillStyle = i%2 ? '#60a5fa' : '#22d3ee'; g.fillRect(x,y,w,h);}
    requestAnimationFrame(loop);
  })();
})();

/* ========= YOUTUBE (VISIBLE PLAYER, controls hidden) ========= */
let ytPlayer=null, ytReadyPromise=null, playerReadyPromise=null;
function loadYTAPI(){
  if(window.YT && window.YT.Player) return Promise.resolve();
  if(ytReadyPromise) return ytReadyPromise;
  ytReadyPromise = new Promise((resolve,reject)=>{
    const s=document.createElement('script');
    s.src='https://www.youtube.com/iframe_api'; s.async=true; s.onerror=()=>reject(new Error('YT API failed'));
    window.onYouTubeIframeAPIReady=()=>resolve();
    document.head.appendChild(s);
  });
  return ytReadyPromise;
}
function createVisiblePlayer(){
  if(ytPlayer) return playerReadyPromise;
  playerReadyPromise = new Promise((resolve)=>{
    ytPlayer = new YT.Player('ytMount',{
      width:'100%', height:'100%', videoId:'',
      host:'https://www.youtube-nocookie.com',
      playerVars:{
        autoplay:0, controls:0, rel:0, modestbranding:1, playsinline:1,
        origin: window.location.origin
      },
      events:{
        onReady: ()=>resolve(),
        onStateChange:(e)=>{
          if(e.data===YT.PlayerState.ENDED) next(true);
          if(e.data===YT.PlayerState.PLAYING){ state.isPlaying=true; updatePlayBtns(); }
          if(e.data===YT.PlayerState.PAUSED){ state.isPlaying=false; updatePlayBtns(); }
        }
      }
    });
  });
  return playerReadyPromise;
}
async function ensureYTReady(){
  await loadYTAPI();
  els.ytMount.classList.remove('hidden');        // show iframe
  els.cover.classList.add('hidden');             // hide cover
  await createVisiblePlayer();
  return true;
}
function ytId(url){ try{ const u=new URL(url); if(u.hostname.includes('youtu.be')) return u.pathname.slice(1); return u.searchParams.get('v'); }catch{return null} }

/* ========= PLAYLIST ========= */
const DEFAULT=[
  {type:'yt', url:'https://www.youtube.com/watch?v=AJtDXIazrMo', title:'APT. ‚Äî ROS√â & Bruno Mars'},
  {type:'yt', url:'https://www.youtube.com/watch?v=BSJa1UytM8w', title:'Saiyaara ‚Äî Faheem Abdullah'},
  {type:'yt', url:'https://www.youtube.com/watch?v=m4iPSPoe1Y8', title:'Naina ‚Äî Arijit Singh'}
];
function loadStore(){ try{ const raw=localStorage.getItem('auroraPlaylist'); state.playlist=raw?JSON.parse(raw):DEFAULT.slice(); }catch{ state.playlist=DEFAULT.slice(); } }
function saveStore(){ localStorage.setItem('auroraPlaylist', JSON.stringify(state.playlist)); }
function keyForMarks(it){ return 'marks:'+ (it.type==='yt'? ytId(it.url) : it.url); }
function getMarks(it){ try{ return JSON.parse(localStorage.getItem(keyForMarks(it)))||[] }catch{return []} }
function saveMarks(it, arr){ localStorage.setItem(keyForMarks(it), JSON.stringify(arr)); }

function renderList(){
  els.list.innerHTML='';
  state.playlist.forEach((it,i)=>{
    const li=document.createElement('li'); li.draggable=true; li.dataset.i=i;
    const id = (it.type==='yt')? ytId(it.url): null;
    const img=document.createElement('img'); img.className='thumb';
    img.src=id?`https://i.ytimg.com/vi/${id}/mqdefault.jpg`:'https://dummyimage.com/112x84/ede9fe/3730a3&text=Audio';
    const main=document.createElement('div');
    const t=document.createElement('div'); t.className='row-title truncate'; t.textContent=it.title || (it.type==='yt'?'YouTube item':'Local file');
    const sub=document.createElement('div'); sub.className='row-sub truncate'; sub.textContent=it.url;
    main.appendChild(t); main.appendChild(sub);
    const act=document.createElement('div'); act.className='row-actions';
    const b1=document.createElement('button'); b1.className='btn ghost'; b1.textContent='Play'; b1.onclick=()=>{state.index=i; loadCurrent(true)};
    const b2=document.createElement('button'); b2.className='btn ghost'; b2.textContent='Remove'; b2.onclick=()=>{state.playlist.splice(i,1); saveStore(); renderList();};
    act.appendChild(b1); act.appendChild(b2);
    li.appendChild(img); li.appendChild(main); li.appendChild(act); els.list.appendChild(li);
  });
  let dragEl=null;
  els.list.querySelectorAll('li').forEach(li=>{
    li.addEventListener('dragstart',e=>{dragEl=li; e.dataTransfer.effectAllowed='move'});
    li.addEventListener('dragover',e=>e.preventDefault());
    li.addEventListener('drop',e=>{
      e.preventDefault(); if(!dragEl||dragEl===li) return;
      const from=+dragEl.dataset.i, to=+li.dataset.i;
      const it=state.playlist.splice(from,1)[0]; state.playlist.splice(to,0,it); saveStore(); renderList();
    });
  });
}

/* ========= BOOKMARKS UI ========= */
function renderMarks(){
  const it=state.playlist[state.index]; if(!it) return;
  const marks = getMarks(it);
  els.marks.innerHTML='';
  for(const m of marks){
    const b=document.createElement('button'); b.className='mark'; b.textContent=m.label+' '+fmt(m.t);
    b.title = 'Jump to '+fmt(m.t);
    b.onclick=()=>seekTo(m.t,true);
    els.marks.appendChild(b);
  }
}

/* ========= LOAD CURRENT ========= */
async function loadCurrent(autoplay=false){
  const it=state.playlist[state.index]; if(!it) return;
  state.A = state.B = null; state.loopAB = false; $('#toggleAB').textContent='A‚ÄìB: OFF';
  state.useYT = (it.type==='yt');

  if(state.useYT){
    await ensureYTReady();
    const id=ytId(it.url); if(!id){ setStatus('Invalid YouTube URL','error'); return; }
    ytPlayer.cueVideoById(id);
    ytPlayer.setVolume(Math.round(state.vol*100));
    setMeta({title:it.title, sub:'YouTube', cover:`https://i.ytimg.com/vi/${id}/hqdefault.jpg`});
    state.duration=0; els.tDur.textContent='‚Äî:‚Äî';
    applyRate(); // set speed
    if(autoplay) ytPlayer.playVideo();
  } else {
    els.cover.classList.remove('hidden'); els.ytMount.classList.add('hidden');
    audioEl.src=it.url;
    await audioEl.play().catch(()=>{}); audioEl.pause();
    state.duration=isFinite(audioEl.duration)?audioEl.duration:0;
    setMeta({title:it.title, sub:'Local File'});
    els.tDur.textContent=fmt(state.duration||0);
    audioEl.playbackRate = state.rate;
    if(autoplay) play();
  }
  renderMarks();
  updatePlayBtns(); updateProgress(); saveStore();
}

/* ========= TRANSPORT + CROSSFADES ========= */
let fading=false;
function crossfade(toPlay){
  if(fading) return toPlay();
  fading=true;
  const start = performance.now(), D=400;
  const startVol=state.vol;
  function step(t){
    const k=Math.min(1,(t-start)/D);
    const v = (1-k);
    if(state.useYT&&ytPlayer) ytPlayer.setVolume(Math.round(startVol*100*v));
    gain.gain.value=startVol*v;
    if(k<1) requestAnimationFrame(step); else { toPlay(); fading=false; }
  }
  requestAnimationFrame(step);
}
function play(){ if(state.useYT&&ytPlayer) ytPlayer.playVideo(); else audioEl.play(); state.isPlaying=true; updatePlayBtns(); setStatus('Playing'); if(ctx.state==='suspended') ctx.resume(); }
function pause(){ if(state.useYT&&ytPlayer) ytPlayer.pauseVideo(); else audioEl.pause(); state.isPlaying=false; updatePlayBtns(); setStatus('Paused'); }
function next(auto=false){ crossfade(()=>{ if(state.shuffle && !auto){ state.index=Math.floor(Math.random()*state.playlist.length) } else if(state.repeat && auto){ } else { state.index=(state.index+1)%state.playlist.length } loadCurrent(true); }); }
function prev(){ crossfade(()=>{ state.index=(state.index-1+state.playlist.length)%state.playlist.length; loadCurrent(true); }); }
function seekBy(d){ const cur=getTime(); const target=Math.max(0,Math.min((state.duration||0),cur+d)); seekTo(target,true); }
function restart(){ seekTo(0,true); }
function volBy(d){ state.vol=Math.max(0,Math.min(1,state.vol+d)); els.vol.value=Math.round(state.vol*100);
  if(state.useYT&&ytPlayer) ytPlayer.setVolume(Math.round(state.vol*100)); gain.gain.value=state.vol*duckFactor; }

/* ========= TIME / PROGRESS ========= */
function getTime(){ return state.useYT&&ytPlayer? (ytPlayer.getCurrentTime?.()||0) : (audioEl.currentTime||0); }
function getDur(){ return state.useYT&&ytPlayer? (ytPlayer.getDuration?.()||state.duration||0) : (isFinite(audioEl.duration)?audioEl.duration:(state.duration||0)); }
function seekTo(s, user){ if(state.useYT&&ytPlayer) ytPlayer.seekTo(s,true); else audioEl.currentTime=s; if(user) state.isPlaying && play(); }
function updateProgress(){
  const pos = getTime(), dur = getDur();
  els.tCur.textContent=fmt(pos); els.tDur.textContent=dur?fmt(dur):'‚Äî:‚Äî';
  els.seek.max=Math.round((dur||1)*1000); els.seek.value=Math.round(pos*1000); state.duration=dur;

  // A‚ÄìB loop check
  if(state.loopAB && state.A!=null && state.B!=null){
    if(pos>=state.B) seekTo(state.A,false);
  }
  requestAnimationFrame(updateProgress);
}
els.seek.addEventListener('input',()=>seekTo(+els.seek.value/1000,true));

/* ========= RATE / SLEEP / THEATER ========= */
function applyRate(){
  if(state.useYT&&ytPlayer&&ytPlayer.setPlaybackRate){
    ytPlayer.setPlaybackRate(state.rate);
  } else {
    audioEl.playbackRate = state.rate;
  }
}
els.rate.addEventListener('change',()=>{ state.rate=+els.rate.value; applyRate(); toast('Speed '+state.rate+'x'); });

els.sleep.addEventListener('change',()=>{
  if(state.sleepId) { clearTimeout(state.sleepId); state.sleepId=null; }
  const m=+els.sleep.value; if(!m){ toast('Sleep off'); return; }
  state.sleepId = setTimeout(()=>{ pause(); toast('Sleep timer: paused'); }, m*60*1000);
  toast('Sleep in '+m+' min');
});

els.theater.addEventListener('click',()=>{
  const on = !els.shell.classList.contains('theater');
  els.shell.classList.toggle('theater', on);
  toast(on?'Theater ON':'Theater OFF');
});

/* ========= DUCKING ========= */
let duckFactor=1;
function applyDuck(f){ duckFactor=f; if(state.useYT&&ytPlayer) ytPlayer.setVolume(Math.round(state.vol*100*f)); gain.gain.value=state.vol*f; }
els.vol.addEventListener('input',()=>{ state.vol=+els.vol.value/100; if(state.useYT&&ytPlayer) ytPlayer.setVolume(Math.round(state.vol*100)); gain.gain.value=state.vol*duckFactor; });
els.duck.addEventListener('input',()=>{ state.duckAmt=+els.duck.value/100; });

/* ========= MIC (toggle) ========= */
let micCtx=null, micAnalyser=null, micLoop=null;
async function startMic(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    micCtx = new (window.AudioContext||window.webkitAudioContext)();
    const src = micCtx.createMediaStreamSource(stream);
    micAnalyser = micCtx.createAnalyser(); micAnalyser.fftSize=1024; src.connect(micAnalyser);
    els.micPill.textContent='mic: on'; els.micPill.classList.add('on'); state.micOn=true;
    micLoop = setInterval(()=>{
      const buf=new Uint8Array(micAnalyser.fftSize); micAnalyser.getByteTimeDomainData(buf);
      let sum=0; for(let i=0;i<buf.length;i++){const v=(buf[i]-128)/128; sum+=v*v}
      const rms=Math.sqrt(sum/buf.length); if(rms>MIC_THRESHOLD) state.lastSpeech=performance.now();
      const since=performance.now()-state.lastSpeech; const target = since<QUIET_DELAY ? (1-state.duckAmt) : 1;
      applyDuck(duckFactor+(target-duckFactor)*0.08);
    }, DUCK_TICK);
    toast('Mic enabled for ducking');
  }catch(e){
    els.micPill.textContent='mic: off'; els.micPill.classList.remove('on'); state.micOn=false; els.micToggle.checked=false;
    setStatus('Mic permission denied ‚Äî ducking disabled','error'); toast('Mic permission denied');
  }
}
function stopMic(){ try{ if(micLoop) clearInterval(micLoop); if(micCtx) micCtx.close(); }catch{} els.micPill.textContent='mic: off'; els.micPill.classList.remove('on'); state.micOn=false; toast('Mic disabled'); }
els.micToggle.addEventListener('change',e=>{ e.target.checked? startMic() : stopMic(); });

/* ========= SPEECH RECOGNITION (toggle; OFF by default) ========= */
let rec=null; const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
function startSpeech(){
  if(!SR){ setStatus('SpeechRecognition not supported','error'); els.speechToggle.checked=false; return; }
  if(rec){ try{rec.stop()}catch{} }
  rec=new SR(); rec.lang='en-GB'; rec.continuous=true; rec.interimResults=false;
  rec.onresult=(e)=>{ for(let i=e.resultIndex;i<e.results.length;i++){ if(e.results[i].isFinal) handleCmd(e.results[i][0].transcript.toLowerCase()) } };
  rec.onerror=()=>{ if(state.speechOn) setTimeout(()=>{ try{rec.start()}catch{} },700) };
  rec.onend = ()=>{ if(state.speechOn) setTimeout(()=>{ try{rec.start()}catch{} },500) };
  try{ rec.start(); toast('Speech input ON'); setStatus('Speech input ON'); }catch{ setStatus('Could not start speech input','error'); }
}
function stopSpeech(){ if(rec){ try{rec.onend=null;rec.onerror=null;rec.stop();}catch{} } toast('Speech input OFF'); setStatus('Speech input OFF'); }
els.speechToggle.addEventListener('change',e=>{ state.speechOn=e.target.checked; state.speechOn? startSpeech(): stopSpeech(); });

function handleCmd(t){
  if(/next/.test(t)) return next();
  if(/prev|previous|back/.test(t)) return prev();
  if(/forward|ahead/.test(t)) return seekBy(+SEEK_STEP);
  if(/rewind|reverse|back/.test(t)) return seekBy(-SEEK_STEP);
  if(/restart|again/.test(t)) return restart();
  if(/pause|stop|wait/.test(t)) return pause();
  if(/play|resume|continue|go on/.test(t)) return play();
  if(/volume up|louder/.test(t)) return volBy(+0.1);
  if(/volume down|quieter/.test(t)) return volBy(-0.1);
  if(/speed|rate/.test(t)) { state.rate=Math.min(2,Math.max(.5,state.rate+.25)); els.rate.value=String(state.rate); applyRate(); toast('Speed '+state.rate+'x'); }
  if(/shuffle/.test(t)){ state.shuffle=!state.shuffle; els.shuffle.checked=state.shuffle; toast('Shuffle '+(state.shuffle?'ON':'OFF')) }
  if(/repeat/.test(t)){ state.repeat=!state.repeat; els.repeat.checked=state.repeat; toast('Repeat '+(state.repeat?'ON':'OFF')) }
}

/* ========= TTS ========= */
let VOICES=[]; function loadVoices(){ VOICES=speechSynthesis.getVoices(); els.voice.innerHTML=VOICES.map((v,i)=>`<option value="${i}">${v.name} (${v.lang})</option>`).join(''); if(state.ttsIndex!=null && VOICES[state.ttsIndex]) els.voice.value=state.ttsIndex; }
speechSynthesis.onvoiceschanged=loadVoices; loadVoices();
els.voice.addEventListener('change',()=>state.ttsIndex=+els.voice.value);
function speak(text,lang){ speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); const v=VOICES[state.ttsIndex]; if(v) u.voice=v; u.lang=v?.lang||lang; u.rate=.95; u.pitch=1; speechSynthesis.speak(u); }
els.speakEn.addEventListener('click',()=>speak(`Now playing ${els.title.textContent}`,'en-GB'));
els.speakUr.addEventListener('click',()=>speak(`ÿßÿ® ⁄ÜŸÑ ÿ±€Åÿß €Å€í ${els.title.textContent}`,'ur-PK'));
els.stopTTS.addEventListener('click',()=>speechSynthesis.cancel());

/* ========= CONTROLS ========= */
els.play.addEventListener('click',()=>state.isPlaying?pause():play());
els.miniPlay.addEventListener('click',()=>state.isPlaying?pause():play());
els.prev.addEventListener('click',prev); els.miniPrev.addEventListener('click',prev);
els.next.addEventListener('click',()=>next(true)); els.miniNext.addEventListener('click',()=>next(true));
els.fwd.addEventListener('click',()=>seekBy(+SEEK_STEP)); els.rew.addEventListener('click',()=>seekBy(-SEEK_STEP));
els.repeat.addEventListener('change',()=>state.repeat=els.repeat.checked);
els.shuffle.addEventListener('change',()=>state.shuffle=els.shuffle.checked);
window.addEventListener('keydown',(e)=>{
  if(['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) return;
  if(e.code==='Space'){ e.preventDefault(); state.isPlaying?pause():play(); }
  if(e.code==='ArrowRight'){ seekBy(e.shiftKey? +SEEK_STEP : +5); }
  if(e.code==='ArrowLeft'){ seekBy(e.shiftKey? -SEEK_STEP : -5); }
});

/* ========= A‚ÄìB LOOP & BOOKMARKS ========= */
$('#setA').addEventListener('click',()=>{ state.A=getTime(); toast('A = '+fmt(state.A)); });
$('#setB').addEventListener('click',()=>{ state.B=getTime(); toast('B = '+fmt(state.B)); });
$('#toggleAB').addEventListener('click',()=>{
  state.loopAB = !state.loopAB;
  $('#toggleAB').textContent = 'A‚ÄìB: ' + (state.loopAB?'ON':'OFF');
});
$('#addMark').addEventListener('click',()=>{
  const it=state.playlist[state.index]; if(!it) return;
  const marks=getMarks(it);
  const t=getTime(); const label='‚óÜ';
  marks.push({t,label}); saveMarks(it,marks); renderMarks(); toast('Bookmark '+fmt(t));
});

/* ========= SHARE (timestamp) ========= */
els.share.addEventListener('click',()=>{
  const it=state.playlist[state.index]; if(!it) return;
  let url=it.url;
  if(it.type==='yt'){ const id=ytId(it.url); const s=Math.floor(getTime()); url=`https://www.youtube.com/watch?v=${id}&t=${s}s`; }
  (navigator.clipboard?.writeText(url)||Promise.reject()).then(()=>toast('Link copied'),()=>toast('Copy failed'));
});

/* ========= ADD / SAVE / CLEAR ========= */
els.addYT.addEventListener('click',()=>{
  const url=prompt('Paste YouTube URL:'); if(!url) return;
  state.playlist.push({type:'yt', url, title:'YouTube'}); saveStore(); renderList();
  if(state.playlist.length===1){ state.index=0; loadCurrent(false); }
});
els.addLocal.addEventListener('change',(e)=>{
  const files=[...e.target.files];
  for(const f of files){ const url=URL.createObjectURL(f); state.playlist.push({type:'local', url, title:f.name}); }
  saveStore(); renderList();
  if(state.playlist.length===files.length){ state.index=0; loadCurrent(false); }
});
els.saveList.addEventListener('click',()=>{ saveStore(); toast('Playlist saved'); });
els.clearList.addEventListener('click',()=>{ if(!confirm('Clear playlist?')) return; state.playlist.length=0; saveStore(); renderList(); toast('Cleared'); });

/* ========= BOOT ========= */
function boot(){
  loadStore(); renderList(); 
  const startIdx = +params.get('i') || 0; state.index = Math.min(startIdx, state.playlist.length-1);
  loadCurrent(false);
  els.vol.value=Math.round(state.vol*100); els.duck.value=Math.round(state.duckAmt*100); updatePlayBtns();
}
boot();

/* ========= Media Session ========= */
if('mediaSession' in navigator){
  navigator.mediaSession.setActionHandler('play', play);
  navigator.mediaSession.setActionHandler('pause', pause);
  navigator.mediaSession.setActionHandler('previoustrack', prev);
  navigator.mediaSession.setActionHandler('nexttrack', ()=>next(true));
  navigator.mediaSession.setActionHandler('seekforward', ()=>seekBy(+SEEK_STEP));
  navigator.mediaSession.setActionHandler('seekbackward', ()=>seekBy(-SEEK_STEP));
}
</script>
</body>
</html>
